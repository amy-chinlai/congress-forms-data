<!DOCTYPE html>
<html>
	<head>
		<title>JSON Overwrite Tester</title>
		<style>
			body {
				font-family: "Helvetica";
				font-size: 14px;
				color: #2c2c2c;
			}
			
			.left, .right {
				width: 50%;
				float: left;
			}
			
			input, textarea, select {
				width: 80%;
				text-decoration: none;
			    font-size: 14px;
			    border-radius: 3px;
			    padding: 7px 10px;
			    border: 1px solid black;
			    min-height: 20px;
			    line-height: 20px;
			    box-sizing: border-box;
			    white-space: normal;
			    display: block;
			    margin: 0px 20px 40px 20px;
			}
			
			label {
				margin: 20px 20px 10px 20px;
				display: block;
				
			}
			
			input[type="submit"] {
			    color: #FFFFFF;
			    background-color: #717171;
			    font-weight: 700;
			    margin-top: 40px;
			}
			
			input[type="radio"] {
				display: inline;
				width: auto;
				margin-bottom: 10px;
			}
			
			textarea {
				height: 300px;
			}
			
			select {
				margin-bottom: 10px;
			}
			
			.disabled {
				background-color: #d0d0d0 !important;
			}
		</style>
	</head>
	<body>
		
		<div class="left">
		
			<label>Overwrite JSON file:</label>
			<select id="overwrite_file_select">
				<option value="">[choose one]</option>
				<option value="https://raw.githubusercontent.com/j-ro/congress-forms-data/master/ocdid_legislatorUpperBody_overwrite.json">legislatorUpperBody</option>
				<option value="https://raw.githubusercontent.com/j-ro/congress-forms-data/master/ocdid_legislatorLowerBody_overwrite.json">legislatorLowerBody</option>
				<option value="https://raw.githubusercontent.com/j-ro/congress-forms-data/master/ocdid_congress_overwrite.json">congress</option>
				<option value="https://raw.githubusercontent.com/j-ro/congress-forms-data/master/ocdid_headOfGovernment_overwrite.json">headOfGovernment</option>
				<option value="https://raw.githubusercontent.com/j-ro/congress-forms-data/master/ocdid_statelevel_upper_overwrite.json">statelevel_upper</option>
				<option value="https://raw.githubusercontent.com/j-ro/congress-forms-data/master/ocdid_statelevel_lower_overwrite.json">statelevel_lower</option>
				<option value="https://raw.githubusercontent.com/j-ro/congress-forms-data/master/ocdid_statelevel_overwrite.json">statelevel</option>
			</select>
			<input type="text" id="overwrite_file" value="" placeholder="...or enter a URL" />
			<label>Google Civic API key:</label>
			<input type="text" id="google_api_key" value="" />
			
			<label>Run which test?</label>
			<label>
				<input name="type" class="type" value="overwrite_name_match" type="radio">
				Name Match (Do overwrite names match Google Civic names?)
			</label>
			<label>
				<input name="type" class="type" value="overwrite_necessity" type="radio">
				Necessity (Do we need overwrites to add emails/phones or change names?)
			</label>
			
			<label>Ignore which states?</label>
			<label>
				<select multiple="true" id="ignore_states">
					<option value="AL">Alabama</option>
					<option value="AK">Alaska</option>
					<option value="AZ">Arizona</option>
					<option value="AR">Arkansas</option>
					<option value="CA">California</option>
					<option value="CO">Colorado</option>
					<option value="CT">Connecticut</option>
					<option value="DE">Delaware</option>
					<option value="DC">District Of Columbia</option>
					<option value="FL">Florida</option>
					<option value="GA">Georgia</option>
					<option value="HI">Hawaii</option>
					<option value="ID">Idaho</option>
					<option value="IL">Illinois</option>
					<option value="IN">Indiana</option>
					<option value="IA">Iowa</option>
					<option value="KS">Kansas</option>
					<option value="KY">Kentucky</option>
					<option value="LA">Louisiana</option>
					<option value="ME">Maine</option>
					<option value="MD">Maryland</option>
					<option value="MA">Massachusetts</option>
					<option value="MI">Michigan</option>
					<option value="MN">Minnesota</option>
					<option value="MS">Mississippi</option>
					<option value="MO">Missouri</option>
					<option value="MT">Montana</option>
					<option value="NE">Nebraska</option>
					<option value="NV">Nevada</option>
					<option value="NH">New Hampshire</option>
					<option value="NJ">New Jersey</option>
					<option value="NM">New Mexico</option>
					<option value="NY">New York</option>
					<option value="NC">North Carolina</option>
					<option value="ND">North Dakota</option>
					<option value="OH">Ohio</option>
					<option value="OK">Oklahoma</option>
					<option value="OR">Oregon</option>
					<option value="PA">Pennsylvania</option>
					<option value="RI">Rhode Island</option>
					<option value="SC">South Carolina</option>
					<option value="SD">South Dakota</option>
					<option value="TN">Tennessee</option>
					<option value="TX">Texas</option>
					<option value="UT">Utah</option>
					<option value="VT">Vermont</option>
					<option value="VA">Virginia</option>
					<option value="WA">Washington</option>
					<option value="WV">West Virginia</option>
					<option value="WI">Wisconsin</option>
					<option value="WY">Wyoming</option>
				</select>
			</label>
			
			<input type="submit" id="submit" value="run" />
		</div>
		
		<div class="right">
			<label>Results:</label>
			<textarea id="results"></textarea>
			
			<label>Log:</label>
			<textarea id="log"></textarea>
		</div>
		
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> 
		
		<script type="text/javascript">
		$(document).ready(function() {
			$('#submit').on('click', function() {
				$('#submit').val('running...').attr('disabled','disabled').addClass('disabled');
				$('textarea').val('');
				if (($('#overwrite_file').val() != '' || $('#overwrite_file_select').val() != '') && $('#google_api_key').val() != '' && $('.type:checked').val() != undefined) {
					if ($('#overwrite_file_select').val() != '') {
						var overwrite_file = $('#overwrite_file_select').val();
					} else {
						var overwrite_file = $('#overwrite_file').val()
					}
					$.getJSON(overwrite_file, function(data) {
						$('textarea').val('start test');
						
						console.log('overwrite file loaded successfully');
						$('#log').val($('#log').val() + '\n' + 'overwrite file loaded successfully');
						
						if ($('.type:checked').val() == 'overwrite_name_match') {
							$('textarea').val($('textarea').val() + '\n' + 'starting overwrite name match test');
						}	
						
						if ($('.type:checked').val() == 'overwrite_necessity') {
							$('textarea').val($('textarea').val() + '\n' + 'starting overwrite necessity test');
						}		
							
						$.each(data, function(index, value) {
							var ocdid = value.officials[0].overwrite_ocdid;
							var overwrite_name = value.officials[0].overwrite_name;
							var name = value.officials[0].name;
							
							console.log('getting ' + ocdid);
							$('#log').val($('#log').val() + '\n' + 'getting ' + ocdid);
							
							
							$.getJSON('https://www.googleapis.com/civicinfo/v2/representatives/' + encodeURIComponent(ocdid) + '?key='+ $('#google_api_key').val(), function(data) {
							
								//overwrite name match test
								if ($('.type:checked').val() == 'overwrite_name_match') {
									var match = false;
									
									if (data.officials && data.officials.length) {
										$.each(data.officials, function(index1, value1) {
											//console.log(value.name + ' == ' + overwrite_name);
											$('#log').val($('#log').val() + '\n' + value1.name + ' == ' + overwrite_name);
											if (value1.name == overwrite_name) {
												match = true;
											}
										});
										
										//console.log(match);
										$('#log').val($('#log').val() + '\n' + 'match? ' + match);
									} else {
										//console.log('no officials found for ' + ocdid);
										$('#log').val($('#log').val() + '\n' + 'no officials found for ' + ocdid);
									}
									
									if (match == false) {
										//console.log(overwrite_name + ' does not match! \n non-matching ocdid: ' + ocdid);
										var log_results = true;
										if ($('#ignore_states option:selected').length) {
											$('#ignore_states option:selected').each(function() {
												if (ocdid.indexOf('state:' + $(this).val().toLowerCase()) != -1) {
													log_results = false;
												}
											});
										}
										
										if (log_results) {
											$('#results').val($('#results').val() + '\n\n' + overwrite_name + ' does not match! \n non-matching ocdid: ' + ocdid);
										}
									}
								}

								//overwrite necessity test
								if ($('.type:checked').val() == 'overwrite_necessity') {
									var match = false;
									var overwrite_object = {};
									
									if (data.officials && data.officials.length) {
										$.each(data.officials, function(index1, value1) {
											//console.log(value.name + ' == ' + overwrite_name);
											$('#log').val($('#log').val() + '\n' + value1.name + ' == ' + overwrite_name);
											if (value1.name == overwrite_name && overwrite_name == name) {
												match = true;
												overwrite_object = value1;
											}
										});
										
										//console.log(match);
										$('#log').val($('#log').val() + '\n' + 'match? ' + match);
									} else {
										//console.log('no officials found for ' + ocdid);
										$('#log').val($('#log').val() + '\n' + 'no officials found for ' + ocdid);
									}
									
									if (match == true) {
										var log_results = true;
										
										if (overwrite_object.phones != undefined && overwrite_object.emails != undefined && overwrite_object.phones.length > 0 && overwrite_object.emails.length > 0) {
											if ($('#ignore_states option:selected').length) {
												$('#ignore_states option:selected').each(function() {
													if (ocdid.indexOf('state:' + $(this).val().toLowerCase()) != -1) {
														log_results = false;
													}
												});
											}
											
											if (log_results) {
												$('#results').val($('#results').val() + '\n\n' + overwrite_name + ' is not necessary! \n non-necessary ocdid: ' + ocdid);
											}
										}
									}
								}

								
								if ($.active == 1) {
									setTimeout(function() {
										$('#submit').val('run').attr('disabled',false).removeClass('disabled');
									}, 1000);
								}
								
							}).fail(function(jqXHR, textStatus, errorThrown) {
								console.log('google api load failed');
								$('#log').val($('#log').val() + '\n' + 'google api load failed');
								
								console.log('jqXHR: ');
								console.log(jqXHR);
								$('#log').val($('#log').val() + '\n' + 'see console for detailed error object');
								
								console.log('textStatus: ' + textStatus);
								$('#log').val($('#log').val() + '\n' + 'textStatus: ' + textStatus);
								
								console.log('errorThrown: ' + errorThrown);
								$('#log').val($('#log').val() + '\n' + 'errorThrown: ' + errorThrown);
								
								$('#submit').val('run').attr('disabled',false).removeClass('disabled');
							});
						});
							
					}).fail(function(jqXHR, textStatus, errorThrown) {
						console.log('overwrite file load failed');
						$('#log').val($('#log').val() + '\n' + 'overwrite file load failed');
						
						console.log('jqXHR: ');
						console.log(jqXHR);
						$('#log').val($('#log').val() + '\n' + 'see console for detailed error object');
						
						console.log('textStatus: ' + textStatus);
						$('#log').val($('#log').val() + '\n' + 'textStatus: ' + textStatus);
						
						console.log('errorThrown: ' + errorThrown);
						$('#log').val($('#log').val() + '\n' + 'errorThrown: ' + errorThrown);
						
						$('#submit').val('run').attr('disabled',false).removeClass('disabled');
					});
					
				} else {
					console.log('please fill in all required fields');
					$('textarea').val('please fill in all required fields');
					
					$('#submit').val('run').attr('disabled',false).removeClass('disabled');
				}
				
			});
		});
		</script>
	</body>
</html>